<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ArxivCaster — Viewer</title>
    <style>
      :root { --bg:#0a0b12; --fg:#f6f7fb; --muted:#9aa4c8; --panel:rgba(255,255,255,0.06); --border:rgba(255,255,255,0.12); }
      html,body{height:100%;margin:0}
      body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial; color:var(--fg); background:var(--bg)}
      .bg{position:fixed; inset:0; z-index:-2; background:
        radial-gradient(1200px 800px at 20% -10%, #223066 0%, transparent 60%),
        radial-gradient(900px 900px at 120% 0%, #3e2a7a 0%, transparent 60%),
        radial-gradient(800px 600px at 80% 110%, #0f3b5f 0%, transparent 55%),
        linear-gradient(180deg, #0a0b12 0%, #0a0b12 100%)}
      .glow{position:fixed; inset:-20vh -20vw; z-index:-1; filter: blur(60px) saturate(120%); background: conic-gradient(from 0deg, #6ea8ff, #b388ff, #6ea8ff); opacity:.3; animation: spin 40s linear infinite}
      @keyframes spin { to { transform: rotate(360deg) } }
      header{max-width:860px;margin:16px auto 0;padding:16px 20px}
      a{color:#e6eaff}
      .wrap{max-width:860px;margin:0 auto 48px;padding:0 20px}
      .paper{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:22px; box-shadow:0 10px 30px #0006; backdrop-filter: blur(8px)}
      .paper h1{margin:0 0 8px; font-size:28px; letter-spacing:-.02em}
      .paper .meta{color:var(--muted);font-size:13px;margin-bottom:12px}
      .paper audio{width:100%; margin:12px 0 20px}
      .md h2{margin:22px 0 10px}
      .md p{line-height:1.75}
      .md ul{padding-left:1.2em}
      .back{display:inline-block;margin-top:16px}
    </style>
  </head>
  <body>
    <div class="bg"></div>
    <div class="glow" aria-hidden="true"></div>
    <header><a href="./">← 一覧へ</a></header>
    <div class="wrap">
      <div id="paper" class="paper">
        <div id="loading">読み込み中...</div>
      </div>
    </div>
    <script>
      const params = new URLSearchParams(location.search);
      const slug = params.get('slug');
      if(!slug){ document.getElementById('paper').textContent='slugが指定されていません'; }
      else { render(slug).catch(e=>{ console.error(e); document.getElementById('paper').textContent='読み込みに失敗しました'; }); }

      async function render(slug){
        const res = await fetch(`posts/${encodeURIComponent(slug)}.md`);
        if(!res.ok) throw new Error('not found');
        const md = await res.text();
        const {meta, body} = splitFrontMatter(md);
        const html = markdownToHtml(body);
        const el = document.getElementById('paper');
        const audioUrl = `episodes/${slug}.mp3`;
        el.innerHTML = `
          <h1>${escapeHtml(meta.title||slug)}</h1>
          <div class="meta">${new Date(meta.date||Date.now()).toLocaleString('ja-JP')}・${slug}</div>
          <audio controls src="${audioUrl}"></audio>
          <div class="md">${html}</div>
          <a class="back" href="./">← 一覧へ戻る</a>
        `;
      }

      function splitFrontMatter(text){
        const m = /^---\n([\s\S]*?)\n---\n([\s\S]*)/m.exec(text);
        const meta = {}; let body=text;
        if(m){
          for(const line of m[1].split(/\n/)){
            const mm = /^(\w+):\s*(.*)$/.exec(line.trim());
            if(mm) meta[mm[1]] = mm[2]?.replace(/^"|"$/g,'');
          }
          body = m[2];
        }
        return {meta, body};
      }

      function markdownToHtml(md){
        md = md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        md = md.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
        md = md.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
        md = md.replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');
        md = md.replace(/^(?:-\s+.+(?:\n|$))+?/gm, (block)=>{
          const items = block.trim().split(/\n/).map(l=>l.replace(/^-[\s]*/, '')).map(t=>`<li>${t}</li>`).join('');
          return `<ul>${items}</ul>`;
        });
        md = md.replace(/&lt;audio([\s\S]*?)&gt;&lt;\/audio&gt;/gm, '<audio$1></audio>');
        md = md.replace(/^(?!<h\d|<ul|<audio|<\/ul|<li)(.+)$/gm, '<p>$1</p>');
        return md;
      }

      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }
    </script>
  </body>
  </html>
